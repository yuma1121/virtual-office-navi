---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const allPosts = await getCollection('blog');
const recentPosts = allPosts
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
  .slice(0, 6);

const categories = [
  { slug: 'comparison', name: '比較・ランキング', description: '料金やサービスを横断比較' },
  { slug: 'review', name: 'サービスレビュー', description: '実際に使った体験レビュー' },
  { slug: 'area', name: 'エリア別おすすめ', description: '地域ごとのおすすめを紹介' },
  { slug: 'howto', name: '使い方・手続き', description: '登記や届出の手順を解説' },
  { slug: 'concern', name: 'お悩み解決', description: 'よくある疑問・不安を解消' },
];

const categoryNameMap: Record<string, string> = {};
categories.forEach((c) => {
  categoryNameMap[c.slug] = c.name;
});

// カテゴリ別記事（各カテゴリ最大3件）
const postsByCategory = categories.map((cat) => ({
  ...cat,
  posts: allPosts
    .filter((p) => p.data.category === cat.slug)
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
    .slice(0, 3),
})).filter((cat) => cat.posts.length > 0);

const services = [
  'GMOオフィスサポート',
  'レゾナンス',
  'NAWABARI',
  'DMMバーチャルオフィス',
  'ワンストップビジネスセンター',
  'Karigo',
  'バーチャルオフィス1',
  'ユナイテッドオフィス',
];
---

<BaseLayout
  title="スモビジバーチャルオフィス | スモビジオーナーのためのバーチャルオフィス比較サイト"
  description="スモビジオーナー向けにバーチャルオフィスの料金・サービスを徹底比較。GMOオフィスサポート、レゾナンス、NAWABARI等の口コミ・評判を実体験ベースでレビュー。"
>
  <!-- Hero Section -->
  <section class="relative bg-gray-900 overflow-hidden">
    <img
      src="/images/common/hero-section-image.png"
      alt=""
      class="absolute inset-0 w-full h-full object-cover opacity-30"
      loading="eager"
    />
    <div class="absolute inset-0 bg-gradient-to-t from-gray-900/60 to-transparent"></div>
    <div class="relative container-wide py-24 md:py-40">
      <div class="max-w-3xl mx-auto text-center">
        <h1 class="hero-title text-3xl md:text-5xl font-bold tracking-tight text-white mb-5">
          スモビジオーナー向け<br />バーチャルオフィスを紹介
        </h1>
        <p class="hero-title text-base md:text-lg text-gray-100 mb-10 max-w-2xl mx-auto">
          料金・機能・口コミを実体験ベースで徹底比較。<br />あなたに合うサービスが見つかります。
        </p>
        <div class="flex flex-col sm:flex-row gap-3 justify-center">
          <a
            href="/blog/virtual-office-osusume"
            class="inline-flex items-center justify-center px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors"
          >
            おすすめ比較を見る
            <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"
              ><path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 5l7 7-7 7"></path></svg
            >
          </a>
          <a
            href="#diagnosis"
            class="inline-flex items-center justify-center px-6 py-3 border border-white/30 text-white font-medium rounded-lg hover:bg-white/10 transition-colors"
          >
            診断で探す
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Scrolling Service Logos -->
  <section class="border-y bg-white overflow-hidden">
    <div class="py-4">
      <p class="text-center text-xs text-gray-400 mb-3">掲載バーチャルオフィスサービス</p>
      <div class="logo-scroll">
        <div class="logo-scroll-inner">
          {
            [...services, ...services].map((name) => (
              <span class="inline-flex items-center px-5 text-sm text-gray-400 font-medium whitespace-nowrap">
                {name}
              </span>
            ))
          }
        </div>
      </div>
    </div>
  </section>

  <!-- Diagnosis Section -->
  <section id="diagnosis" class="py-10 md:py-14 bg-blue-50/50">
    <div class="container-wide">
      <div class="max-w-2xl mx-auto text-center">
        <h2 class="text-lg font-semibold text-gray-900 mb-2">あなたにぴったりのバーチャルオフィスは？</h2>
        <p class="text-sm text-gray-500 mb-6">3つの質問に答えるだけで、最適なサービスをご提案します。</p>
        <div id="diagnosis-app" class="bg-white rounded-lg border border-gray-200 p-6 md:p-8">
          <div id="diagnosis-questions">
            <!-- Q1 -->
            <div class="diagnosis-step" data-step="1">
              <p class="text-sm text-blue-600 font-medium mb-1">Q1 / 3</p>
              <p class="font-semibold text-gray-900 mb-4">主な利用目的は？</p>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                <button class="diagnosis-btn" data-q="purpose" data-v="registration">法人登記・開業届の住所</button>
                <button class="diagnosis-btn" data-q="purpose" data-v="privacy">自宅住所を隠したい</button>
                <button class="diagnosis-btn" data-q="purpose" data-v="branding">都心一等地の住所が欲しい</button>
                <button class="diagnosis-btn" data-q="purpose" data-v="all">総合的に使いたい</button>
              </div>
            </div>
            <!-- Q2 -->
            <div class="diagnosis-step hidden" data-step="2">
              <p class="text-sm text-blue-600 font-medium mb-1">Q2 / 3</p>
              <p class="font-semibold text-gray-900 mb-4">月額予算は？</p>
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                <button class="diagnosis-btn" data-q="budget" data-v="low">〜1,000円</button>
                <button class="diagnosis-btn" data-q="budget" data-v="mid">1,000〜3,000円</button>
                <button class="diagnosis-btn" data-q="budget" data-v="high">3,000円〜</button>
              </div>
            </div>
            <!-- Q3 -->
            <div class="diagnosis-step hidden" data-step="3">
              <p class="text-sm text-blue-600 font-medium mb-1">Q3 / 3</p>
              <p class="font-semibold text-gray-900 mb-4">郵便物の転送は必要？</p>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                <button class="diagnosis-btn" data-q="mail" data-v="yes">必要</button>
                <button class="diagnosis-btn" data-q="mail" data-v="no">不要</button>
              </div>
            </div>
          </div>
          <!-- Result -->
          <div id="diagnosis-result" class="hidden">
            <p class="text-sm text-blue-600 font-medium mb-2">あなたにおすすめ</p>
            <p id="diagnosis-service" class="text-xl font-bold text-gray-900 mb-2"></p>
            <p id="diagnosis-reason" class="text-sm text-gray-500 mb-4"></p>
            <a id="diagnosis-link" href="" class="inline-flex items-center text-sm text-blue-600 hover:text-blue-800 font-medium">
              詳しく見る →
            </a>
            <button id="diagnosis-reset" class="block mx-auto mt-4 text-xs text-gray-400 hover:text-gray-600">もう一度診断する</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Categories Navigation -->
  <section class="py-10 md:py-12 border-t bg-gray-50/30">
    <div class="container-wide">
      <h2 class="text-lg font-semibold text-gray-900 mb-5">目的から探す</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
        {
          categories.map((cat) => (
            <a
              href={`/category/${cat.slug}`}
              class="block rounded-lg border border-gray-200 bg-white px-4 py-3 hover:border-blue-300 hover:bg-blue-50/40 transition-all"
            >
              <span class="block text-sm font-medium text-gray-900">{cat.name}</span>
              <span class="block text-xs text-gray-400 mt-0.5">{cat.description}</span>
            </a>
          ))
        }
      </div>
    </div>
  </section>

  <!-- Recent Posts -->
  <section id="recent-posts" class="py-10 md:py-12 border-t">
    <div class="container-wide">
      <h2 class="text-lg font-semibold text-gray-900 mb-5">最新記事</h2>
      {
        recentPosts.length > 0 ? (
          <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
            {recentPosts.map((post) => (
              <a
                href={`/blog/${post.slug}`}
                class="group block bg-white rounded-lg border border-gray-200 p-5 hover:border-blue-300 hover:shadow-sm transition-all"
              >
                <div class="flex items-center gap-2 mb-2.5">
                  <span class="text-xs text-blue-600 font-medium">
                    {categoryNameMap[post.data.category] || post.data.category}
                  </span>
                  <span class="text-gray-200">|</span>
                  <time class="text-xs text-gray-400">
                    {post.data.pubDate.toLocaleDateString('ja-JP')}
                  </time>
                </div>
                <h3 class="text-[15px] font-semibold text-gray-900 leading-snug group-hover:text-blue-600 transition-colors">
                  {post.data.title}
                </h3>
                <p class="mt-2 text-sm text-gray-500 line-clamp-2">{post.data.description}</p>
              </a>
            ))}
          </div>
        ) : (
          <p class="text-gray-500">記事を準備中です。</p>
        )
      }
    </div>
  </section>

  <!-- Category Posts Sections -->
  {
    postsByCategory.map((cat) => (
      <section class="py-10 md:py-12 border-t">
        <div class="container-wide">
          <div class="flex items-center justify-between mb-5">
            <h2 class="text-lg font-semibold text-gray-900">{cat.name}</h2>
            <a
              href={`/category/${cat.slug}`}
              class="text-sm text-blue-600 hover:text-blue-800 font-medium"
            >
              もっと見る →
            </a>
          </div>
          <div class="grid md:grid-cols-3 gap-4">
            {cat.posts.map((post) => (
              <a
                href={`/blog/${post.slug}`}
                class="group block bg-white rounded-lg border border-gray-200 p-5 hover:border-blue-300 hover:shadow-sm transition-all"
              >
                <h3 class="text-[15px] font-semibold text-gray-900 leading-snug group-hover:text-blue-600 transition-colors">
                  {post.data.title}
                </h3>
                <p class="mt-2 text-sm text-gray-500 line-clamp-2">{post.data.description}</p>
              </a>
            ))}
          </div>
        </div>
      </section>
    ))
  }

</BaseLayout>

<style>
  .logo-scroll {
    width: 100%;
    overflow: hidden;
  }
  .logo-scroll-inner {
    display: flex;
    width: max-content;
    animation: scroll-logos 20s linear infinite;
  }
  @keyframes scroll-logos {
    0% { transform: translateX(0); }
    100% { transform: translateX(-50%); }
  }
  .diagnosis-btn {
    padding: 0.625rem 1rem;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    color: #374151;
    text-align: left;
    transition: all 0.15s;
  }
  .diagnosis-btn:hover {
    border-color: #93c5fd;
    background-color: #eff6ff;
    color: #2563eb;
  }
  .hero-title {
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
  }
</style>

<script>
  const answers: Record<string, string> = {};
  const steps = document.querySelectorAll('.diagnosis-step');
  const resultEl = document.getElementById('diagnosis-result');
  const questionsEl = document.getElementById('diagnosis-questions');

  document.querySelectorAll('.diagnosis-btn').forEach((btn) => {
    btn.addEventListener('click', () => {
      const q = (btn as HTMLElement).dataset.q!;
      const v = (btn as HTMLElement).dataset.v!;
      answers[q] = v;

      const currentStep = (btn as HTMLElement).closest('.diagnosis-step') as HTMLElement;
      const nextStep = currentStep.nextElementSibling as HTMLElement | null;

      if (nextStep && nextStep.classList.contains('diagnosis-step')) {
        currentStep.classList.add('hidden');
        nextStep.classList.remove('hidden');
      } else {
        showResult();
      }
    });
  });

  function showResult() {
    questionsEl!.classList.add('hidden');
    resultEl!.classList.remove('hidden');

    let service = 'GMOオフィスサポート';
    let reason = '法人登記対応・郵便転送・コスパのバランスが良く、初めての方に最適です。';
    let link = '/blog/gmo-office-support-review';

    if (answers.budget === 'low') {
      service = 'レゾナンス';
      reason = '月額990円〜と業界最安クラス。コストを抑えたい方におすすめです。';
      link = '/blog/gmo-vs-resonance';
    } else if (answers.purpose === 'privacy') {
      service = 'NAWABARI';
      reason = 'ネットショップの特定商取引法対策に強く、住所を隠したい方に最適です。';
      link = '/blog/virtual-office-netshop';
    } else if (answers.purpose === 'branding') {
      service = 'DMMバーチャルオフィス';
      reason = '渋谷・銀座など一等地の住所が使えて、ブランド力を高められます。';
      link = '/blog/virtual-office-tokyo';
    }

    document.getElementById('diagnosis-service')!.textContent = service;
    document.getElementById('diagnosis-reason')!.textContent = reason;
    document.getElementById('diagnosis-link')!.setAttribute('href', link);
  }

  document.getElementById('diagnosis-reset')?.addEventListener('click', () => {
    Object.keys(answers).forEach((k) => delete answers[k]);
    steps.forEach((s, i) => {
      if (i === 0) s.classList.remove('hidden');
      else s.classList.add('hidden');
    });
    questionsEl!.classList.remove('hidden');
    resultEl!.classList.add('hidden');
  });
</script>
