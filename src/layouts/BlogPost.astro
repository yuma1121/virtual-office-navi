---
import BaseLayout from './BaseLayout.astro';
import TOC from '../components/TOC.astro';
import CTAButton from '../components/CTAButton.astro';
import RelatedPosts from '../components/RelatedPosts.astro';
import type { CollectionEntry } from 'astro:content';

export interface Props {
  title: string;
  description: string;
  pubDate: Date;
  updatedDate?: Date;
  heroImage?: string;
  affiliateLinks?: { name: string; url: string; cta: string }[];
  category: string;
  tags: string[];
  slug: string;
}

const { title, description, pubDate, updatedDate, heroImage, affiliateLinks, category, tags, slug } =
  Astro.props;

const categoryLabels: Record<string, string> = {
  comparison: '比較',
  review: 'レビュー',
  howto: '使い方・手続き',
  area: 'エリア情報',
  concern: 'お悩み解決',
};

const breadcrumbs = [
  { name: 'ホーム', url: '/' },
  { name: categoryLabels[category] || category, url: `/category/${category}` },
  { name: title, url: '' },
];
---

<BaseLayout
  title={title}
  description={description}
  ogImage={heroImage}
  pubDate={pubDate}
  updatedDate={updatedDate}
  isArticle={true}
  breadcrumbs={breadcrumbs}
>
  <article class="max-w-4xl mx-auto px-4 py-8 sm:py-12">
    <!-- Breadcrumb -->
    <nav class="text-sm text-gray-500 mb-6" aria-label="パンくずリスト">
      <ol class="flex items-center space-x-2">
        <li><a href="/" class="hover:text-primary-600">ホーム</a></li>
        <li>/</li>
        <li>
          <a href={`/category/${category}`} class="hover:text-primary-600">
            {categoryLabels[category] || category}
          </a>
        </li>
        <li>/</li>
        <li class="text-gray-700 truncate max-w-[200px]">{title}</li>
      </ol>
    </nav>

    <!-- Article Header -->
    <header class="mb-8">
      <div class="flex items-center gap-2 mb-3">
        <span class="inline-block bg-primary-100 text-primary-800 text-xs font-medium px-3 py-1 rounded-full">
          {categoryLabels[category] || category}
        </span>
      </div>
      <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-navy leading-tight mb-4">
        {title}
      </h1>
      <div class="flex items-center gap-4 text-sm text-gray-500">
        <time datetime={pubDate.toISOString()}>
          公開: {pubDate.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' })}
        </time>
        {updatedDate && (
          <time datetime={updatedDate.toISOString()}>
            更新: {updatedDate.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' })}
          </time>
        )}
      </div>
    </header>

    {heroImage && (
      <div class="mb-8 rounded-lg overflow-hidden">
        <img
          src={heroImage}
          alt={title}
          class="w-full h-auto object-cover"
          loading="lazy"
        />
      </div>
    )}

    <!-- Table of Contents -->
    <TOC />

    <!-- Article Body -->
    <div class="prose prose-lg max-w-none prose-headings:text-navy prose-a:text-primary-600 prose-a:no-underline hover:prose-a:underline mb-12">
      <slot />
    </div>

    <!-- Affiliate CTA Section -->
    {affiliateLinks && affiliateLinks.length > 0 && (
      <aside class="bg-gradient-to-r from-blue-600 to-blue-800 rounded-xl p-6 sm:p-8 mb-12 text-white">
        <h2 class="text-xl font-bold text-white mb-4">おすすめバーチャルオフィス</h2>
        <p class="text-blue-100 mb-6">この記事で紹介したサービスの詳細はこちらからご確認いただけます。</p>
        <div class="flex flex-col sm:flex-row gap-4">
          {affiliateLinks.map((link) => (
            <CTAButton
              serviceName={link.name}
              url={link.url}
              ctaText={link.cta}
            />
          ))}
        </div>
      </aside>
    )}

    <!-- Tags -->
    {tags.length > 0 && (
      <div class="border-t pt-6">
        <div class="flex flex-wrap gap-2">
          {tags.map((tag) => (
            <span class="bg-gray-100 text-gray-600 text-sm px-3 py-1 rounded-full">
              #{tag}
            </span>
          ))}
        </div>
      </div>
    )}

    <RelatedPosts category={category} currentSlug={slug} />
  </article>
</BaseLayout>
